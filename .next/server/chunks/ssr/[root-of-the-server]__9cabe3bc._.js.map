{"version":3,"sources":["../../../../node_modules/.pnpm/%40clerk%2Bnextjs%406.36.2_next%401_4d9ce1d952d8168bf504b610f262e563/node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js","../../../../app/actions/stripe.ts","../../../../.next-internal/server/app/%28dashboard%29/dashboard/deposit/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n","// app/actions/stripe.ts\n\"use server\";\n\nimport { stripe } from \"@/lib/stripe\";\nimport { auth } from \"@clerk/nextjs/server\";\nimport { Account } from \"@/lib/models\";\nimport dbConnect from \"@/lib/mongodb\";\n\nconst DEPOSIT_OPTIONS = [\n  { id: \"deposit-100\", name: \"Deposit $100\", amount: 10000 },\n  { id: \"deposit-500\", name: \"Deposit $500\", amount: 50000 },\n  { id: \"deposit-1000\", name: \"Deposit $1,000\", amount: 100000 },\n  { id: \"deposit-5000\", name: \"Deposit $5,000\", amount: 500000 },\n];\n\nexport async function startDepositCheckout(\n  depositId: string,\n  accountId: string\n) {\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  const deposit = DEPOSIT_OPTIONS.find((d) => d.id === depositId);\n  if (!deposit) throw new Error(`Deposit option \"${depositId}\" not found`);\n\n  await dbConnect();\n  const account = await Account.findOne({ _id: accountId, userId }).lean();\n  if (!account) throw new Error(\"Account not found\");\n\n  console.log(\"Creating checkout session:\", {\n    depositId,\n    accountId,\n    amount: deposit.amount / 100,\n    userId,\n  });\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    // FIX 1: Add return_url instead of redirect_on_completion\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: deposit.name,\n            description: `Add funds to your ${account.accountType} account (${account.accountNumber})`,\n          },\n          unit_amount: deposit.amount,\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId,\n      accountId,\n      depositId,\n      amount: (deposit.amount / 100).toString(),\n      type: \"deposit\",\n    },\n  });\n\n  console.log(\"✅ Checkout session created:\", sessionObj.id);\n  return sessionObj.client_secret;\n}\n\nexport async function startCustomDepositCheckout(\n  amount: number,\n  accountId: string\n) {\n  if (amount < 10 || amount > 100000)\n    throw new Error(\"Amount must be between $10 and $100,000\");\n\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  await dbConnect();\n  const account = await Account.findOne({ _id: accountId, userId }).lean();\n  if (!account) throw new Error(\"Account not found\");\n\n  console.log(\"Creating custom checkout session:\", {\n    amount,\n    accountId,\n    userId,\n  });\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    // FIX 1: Add return_url instead of redirect_on_completion\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: `Deposit $${amount.toFixed(2)}`,\n            description: `Add funds to your ${account.accountType} account (${account.accountNumber})`,\n          },\n          unit_amount: Math.round(amount * 100),\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId,\n      accountId,\n      depositId: \"custom\",\n      amount: amount.toString(),\n      type: \"deposit\",\n    },\n  });\n\n  console.log(\"✅ Custom checkout session created:\", sessionObj.id);\n  return sessionObj.client_secret;\n}\n\n// Helper function to retrieve session status\nexport async function getCheckoutSessionStatus(sessionId: string) {\n  try {\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n    console.log(\"Session status:\", {\n      id: session.id,\n      status: session.status,\n      payment_status: session.payment_status,\n    });\n\n    return {\n      status: session.status,\n      payment_status: session.payment_status,\n      customer_email: session.customer_details?.email,\n      amount_total: session.amount_total,\n    };\n  } catch (error) {\n    console.error(\"❌ Error retrieving session:\", error);\n    return null;\n  }\n}\n// Add this import at the top if not already there\nimport type Stripe from \"stripe\";\n\n// EMI Payment Checkout\nexport async function startEMIPaymentCheckout(emiId: string, loanId: string) {\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  await dbConnect();\n\n  const { Loan, EmiPayment } = await import(\"@/lib/models\");\n\n  const loan = await Loan.findOne({ _id: loanId, userId }).lean();\n  if (!loan) throw new Error(\"Loan not found\");\n\n  const emi = await EmiPayment.findOne({ _id: emiId, loanId }).lean();\n  if (!emi) throw new Error(\"EMI not found\");\n\n  if (emi.status === \"paid\") {\n    throw new Error(\"This EMI has already been paid\");\n  }\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/loans/emi-return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: `EMI Payment #${emi.emiNumber}`,\n            description: `${loan.loanType} Loan - Due ${new Date(\n              emi.dueDate\n            ).toLocaleDateString()}`,\n          },\n          unit_amount: Math.round(emi.amount * 100),\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId: userId,\n      loanId: loanId.toString(),\n      emiId: emiId.toString(),\n      emiNumber: emi.emiNumber.toString(),\n      amount: emi.amount.toString(),\n      type: \"emi_payment\",\n    },\n  });\n\n  return sessionObj.client_secret;\n}\n\n// Handle EMI Payment Success\nexport async function handleEMIPaymentSuccess(sessionId: string) {\n  try {\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n    if (session.payment_status !== \"paid\") {\n      return { success: false, message: \"Payment not completed\" };\n    }\n\n    const metadata = session.metadata || {};\n    const userId = metadata.userId;\n    const loanId = metadata.loanId;\n    const emiId = metadata.emiId;\n    const amount = metadata.amount;\n\n    if (!userId || !loanId || !emiId || !amount) {\n      throw new Error(\"Missing required metadata\");\n    }\n\n    await dbConnect();\n    const { Loan, EmiPayment, Transaction, Account } = await import(\n      \"@/lib/models\"\n    );\n\n    const emi = await EmiPayment.findByIdAndUpdate(\n      emiId,\n      {\n        status: \"paid\",\n        paidDate: new Date(),\n        paidAmount: parseFloat(amount),\n      },\n      { new: true }\n    );\n\n    if (!emi) throw new Error(\"EMI not found\");\n\n    const loan = await Loan.findById(loanId);\n    if (!loan) throw new Error(\"Loan not found\");\n\n    loan.amountPaid = (loan.amountPaid || 0) + parseFloat(amount);\n\n    const totalPaid = loan.amountPaid;\n    const totalAmount = loan.amount + (loan.interestAmount || 0);\n\n    if (totalPaid >= totalAmount) {\n      loan.status = \"closed\";\n    }\n\n    await loan.save();\n\n    const transaction = await Transaction.create({\n      userId,\n      accountId: loan.disbursementAccountId,\n      type: \"emi_payment\",\n      amount: -parseFloat(amount),\n      status: \"completed\",\n      description: `EMI #${emi.emiNumber} payment for ${loan.loanType} loan`,\n      reference: sessionId,\n    });\n\n    await Account.findByIdAndUpdate(loan.disbursementAccountId, {\n      $inc: { balance: -parseFloat(amount) },\n    });\n\n    return {\n      success: true,\n      message: \"EMI payment successful\",\n      emiNumber: emi.emiNumber,\n      amount: parseFloat(amount),\n    };\n  } catch (error) {\n    console.error(\"❌ Error processing EMI payment:\", error);\n    return {\n      success: false,\n      message:\n        error instanceof Error ? error.message : \"Payment processing failed\",\n    };\n  }\n}\n","export {detectKeylessEnvDriftAction as '7f47cb11a0010ea4cc7ad41c926056b954e3db6099'} from 'ACTIONS_MODULE0'\nexport {invalidateCacheAction as '7f601cf17d321933b7718dda0ad07ddf64517f96a2'} from 'ACTIONS_MODULE1'\nexport {createOrReadKeylessAction as '7f720a9cac0ca6079785dfa771821b92848e85e41e'} from 'ACTIONS_MODULE0'\nexport {collectKeylessMetadata as '7fb545d622a788d88cc0b55d8325ede161f3a6fe5a'} from 'ACTIONS_MODULE2'\nexport {formatMetadataHeaders as '7ff84d760a69607c4efdf3bca99940f7d5053bb915'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '7f26b9e111ce47d8c28518e45eb38643f535ab32d6'} from 'ACTIONS_MODULE0'\nexport {detectKeylessEnvDriftAction as '7f47cb11a0010ea4cc7ad41c926056b954e3db6099'} from 'ACTIONS_MODULE0'\nexport {createOrReadKeylessAction as '7f720a9cac0ca6079785dfa771821b92848e85e41e'} from 'ACTIONS_MODULE0'\nexport {deleteKeylessAction as '7fcc892355fac0aba6230351d5caf246c2dba1b71d'} from 'ACTIONS_MODULE0'\nexport {deleteKeylessAction as '7fcc892355fac0aba6230351d5caf246c2dba1b71d'} from 'ACTIONS_MODULE0'\nexport {syncKeylessConfigAction as '7f26b9e111ce47d8c28518e45eb38643f535ab32d6'} from 'ACTIONS_MODULE0'\nexport {startDepositCheckout as '607e976aed26103946f2417047419cafb2c31a523d'} from 'ACTIONS_MODULE3'\nexport {startCustomDepositCheckout as '60429288925cf7be0fd4025e1bb62d662780b654c3'} from 'ACTIONS_MODULE3'\n"],"names":[],"mappings":"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","ignoreList":[0]}