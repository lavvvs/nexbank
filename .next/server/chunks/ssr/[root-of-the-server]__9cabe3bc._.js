module.exports=[38724,a=>{"use strict";var b=a.i(1956);a.i(52314);var c=a.i(23809);async function d(){(await (0,c.cookies)()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`)}(0,a.i(27603).ensureServerEntryExports)([d]),(0,b.registerServerReference)(d,"7f601cf17d321933b7718dda0ad07ddf64517f96a2",null),a.s(["invalidateCacheAction",()=>d])},54799,(a,b,c)=>{b.exports=a.x("crypto",()=>require("crypto"))},27699,(a,b,c)=>{b.exports=a.x("events",()=>require("events"))},21517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},24836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},33405,(a,b,c)=>{b.exports=a.x("child_process",()=>require("child_process"))},99044,a=>{"use strict";var b=a.i(1956),c=a.i(27071),d=a.i(21705),e=a.i(13761),f=a.i(22017),g=a.i(27603);let h=[{id:"deposit-100",name:"Deposit $100",amount:1e4},{id:"deposit-500",name:"Deposit $500",amount:5e4},{id:"deposit-1000",name:"Deposit $1,000",amount:1e5},{id:"deposit-5000",name:"Deposit $5,000",amount:5e5}];async function i(a,b){let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");let i=h.find(b=>b.id===a);if(!i)throw Error(`Deposit option "${a}" not found`);await (0,f.default)();let j=await e.Account.findOne({_id:b,userId:g}).lean();if(!j)throw Error("Account not found");console.log("Creating checkout session:",{depositId:a,accountId:b,amount:i.amount/100,userId:g});let k=await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:i.name,description:`Add funds to your ${j.accountType} account (${j.accountNumber})`},unit_amount:i.amount},quantity:1}],mode:"payment",metadata:{userId:g,accountId:b,depositId:a,amount:(i.amount/100).toString(),type:"deposit"}});return console.log("✅ Checkout session created:",k.id),k.client_secret}async function j(a,b){if(a<10||a>1e5)throw Error("Amount must be between $10 and $100,000");let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");await (0,f.default)();let h=await e.Account.findOne({_id:b,userId:g}).lean();if(!h)throw Error("Account not found");console.log("Creating custom checkout session:",{amount:a,accountId:b,userId:g});let i=await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:`Deposit $${a.toFixed(2)}`,description:`Add funds to your ${h.accountType} account (${h.accountNumber})`},unit_amount:Math.round(100*a)},quantity:1}],mode:"payment",metadata:{userId:g,accountId:b,depositId:"custom",amount:a.toString(),type:"deposit"}});return console.log("✅ Custom checkout session created:",i.id),i.client_secret}async function k(a){try{let b=await c.stripe.checkout.sessions.retrieve(a);return console.log("Session status:",{id:b.id,status:b.status,payment_status:b.payment_status}),{status:b.status,payment_status:b.payment_status,customer_email:b.customer_details?.email,amount_total:b.amount_total}}catch(a){return console.error("❌ Error retrieving session:",a),null}}async function l(b,e){let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");await (0,f.default)();let{Loan:h,EmiPayment:i}=await a.A(2050),j=await h.findOne({_id:e,userId:g}).lean();if(!j)throw Error("Loan not found");let k=await i.findOne({_id:b,loanId:e}).lean();if(!k)throw Error("EMI not found");if("paid"===k.status)throw Error("This EMI has already been paid");return(await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/loans/emi-return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:`EMI Payment #${k.emiNumber}`,description:`${j.loanType} Loan - Due ${new Date(k.dueDate).toLocaleDateString()}`},unit_amount:Math.round(100*k.amount)},quantity:1}],mode:"payment",metadata:{userId:g,loanId:e.toString(),emiId:b.toString(),emiNumber:k.emiNumber.toString(),amount:k.amount.toString(),type:"emi_payment"}})).client_secret}async function m(b){try{let d=await c.stripe.checkout.sessions.retrieve(b);if("paid"!==d.payment_status)return{success:!1,message:"Payment not completed"};let e=d.metadata||{},g=e.userId,h=e.loanId,i=e.emiId,j=e.amount;if(!g||!h||!i||!j)throw Error("Missing required metadata");await (0,f.default)();let{Loan:k,EmiPayment:l,Transaction:m,Account:n}=await a.A(2050),o=await l.findByIdAndUpdate(i,{status:"paid",paidDate:new Date,paidAmount:parseFloat(j)},{new:!0});if(!o)throw Error("EMI not found");let p=await k.findById(h);if(!p)throw Error("Loan not found");p.amountPaid=(p.amountPaid||0)+parseFloat(j);let q=p.amountPaid,r=p.amount+(p.interestAmount||0);return q>=r&&(p.status="closed"),await p.save(),await m.create({userId:g,accountId:p.disbursementAccountId,type:"emi_payment",amount:-parseFloat(j),status:"completed",description:`EMI #${o.emiNumber} payment for ${p.loanType} loan`,reference:b}),await n.findByIdAndUpdate(p.disbursementAccountId,{$inc:{balance:-parseFloat(j)}}),{success:!0,message:"EMI payment successful",emiNumber:o.emiNumber,amount:parseFloat(j)}}catch(a){return console.error("❌ Error processing EMI payment:",a),{success:!1,message:a instanceof Error?a.message:"Payment processing failed"}}}(0,g.ensureServerEntryExports)([i,j,k,l,m]),(0,b.registerServerReference)(i,"607e976aed26103946f2417047419cafb2c31a523d",null),(0,b.registerServerReference)(j,"60429288925cf7be0fd4025e1bb62d662780b654c3",null),(0,b.registerServerReference)(k,"4007a2597564fe9d55e48129aaa632373d13e33058",null),(0,b.registerServerReference)(l,"60dcc0a6fcbb3b27a67cf6becb2c0a6cbace7f9735",null),(0,b.registerServerReference)(m,"40d74d057b6e66fced094c113a69cbbb525c1e13e5",null),a.s(["getCheckoutSessionStatus",()=>k,"handleEMIPaymentSuccess",()=>m,"startCustomDepositCheckout",()=>j,"startDepositCheckout",()=>i,"startEMIPaymentCheckout",()=>l])},1252,a=>{"use strict";var b=a.i(77397),c=a.i(38724),d=a.i(79627),e=a.i(99044);a.s([],35023),a.i(35023),a.s(["60429288925cf7be0fd4025e1bb62d662780b654c3",()=>e.startCustomDepositCheckout,"607e976aed26103946f2417047419cafb2c31a523d",()=>e.startDepositCheckout,"7f26b9e111ce47d8c28518e45eb38643f535ab32d6",()=>b.syncKeylessConfigAction,"7f47cb11a0010ea4cc7ad41c926056b954e3db6099",()=>b.detectKeylessEnvDriftAction,"7f601cf17d321933b7718dda0ad07ddf64517f96a2",()=>c.invalidateCacheAction,"7f720a9cac0ca6079785dfa771821b92848e85e41e",()=>b.createOrReadKeylessAction,"7fb545d622a788d88cc0b55d8325ede161f3a6fe5a",()=>d.collectKeylessMetadata,"7fcc892355fac0aba6230351d5caf246c2dba1b71d",()=>b.deleteKeylessAction,"7ff84d760a69607c4efdf3bca99940f7d5053bb915",()=>d.formatMetadataHeaders],1252)},2050,a=>{a.v(a=>Promise.resolve().then(()=>a(13761)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__9cabe3bc._.js.map