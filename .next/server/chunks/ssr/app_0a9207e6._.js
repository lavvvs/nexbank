module.exports=[99044,a=>{"use strict";var b=a.i(1956),c=a.i(27071),d=a.i(21705),e=a.i(13761),f=a.i(22017),g=a.i(27603);let h=[{id:"deposit-100",name:"Deposit $100",amount:1e4},{id:"deposit-500",name:"Deposit $500",amount:5e4},{id:"deposit-1000",name:"Deposit $1,000",amount:1e5},{id:"deposit-5000",name:"Deposit $5,000",amount:5e5}];async function i(a,b){let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");let i=h.find(b=>b.id===a);if(!i)throw Error(`Deposit option "${a}" not found`);await (0,f.default)();let j=await e.Account.findOne({_id:b,userId:g}).lean();if(!j)throw Error("Account not found");console.log("Creating checkout session:",{depositId:a,accountId:b,amount:i.amount/100,userId:g});let k=await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:i.name,description:`Add funds to your ${j.accountType} account (${j.accountNumber})`},unit_amount:i.amount},quantity:1}],mode:"payment",metadata:{userId:g,accountId:b,depositId:a,amount:(i.amount/100).toString(),type:"deposit"}});return console.log("‚úÖ Checkout session created:",k.id),k.client_secret}async function j(a,b){if(a<10||a>1e5)throw Error("Amount must be between $10 and $100,000");let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");await (0,f.default)();let h=await e.Account.findOne({_id:b,userId:g}).lean();if(!h)throw Error("Account not found");console.log("Creating custom checkout session:",{amount:a,accountId:b,userId:g});let i=await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:`Deposit $${a.toFixed(2)}`,description:`Add funds to your ${h.accountType} account (${h.accountNumber})`},unit_amount:Math.round(100*a)},quantity:1}],mode:"payment",metadata:{userId:g,accountId:b,depositId:"custom",amount:a.toString(),type:"deposit"}});return console.log("‚úÖ Custom checkout session created:",i.id),i.client_secret}async function k(a){try{let b=await c.stripe.checkout.sessions.retrieve(a);return console.log("Session status:",{id:b.id,status:b.status,payment_status:b.payment_status}),{status:b.status,payment_status:b.payment_status,customer_email:b.customer_details?.email,amount_total:b.amount_total}}catch(a){return console.error("‚ùå Error retrieving session:",a),null}}async function l(b,e){let g=(await (0,d.auth)()).userId;if(!g)throw Error("You must be logged in");await (0,f.default)();let{Loan:h,EmiPayment:i}=await a.A(2050),j=await h.findOne({_id:e,userId:g}).lean();if(!j)throw Error("Loan not found");let k=await i.findOne({_id:b,loanId:e}).lean();if(!k)throw Error("EMI not found");if("paid"===k.status)throw Error("This EMI has already been paid");return(await c.stripe.checkout.sessions.create({ui_mode:"embedded",return_url:"http://localhost:3000/dashboard/loans/emi-return?session_id={CHECKOUT_SESSION_ID}",line_items:[{price_data:{currency:"usd",product_data:{name:`EMI Payment #${k.emiNumber}`,description:`${j.loanType} Loan - Due ${new Date(k.dueDate).toLocaleDateString()}`},unit_amount:Math.round(100*k.amount)},quantity:1}],mode:"payment",metadata:{userId:g,loanId:e.toString(),emiId:b.toString(),emiNumber:k.emiNumber.toString(),amount:k.amount.toString(),type:"emi_payment"}})).client_secret}async function m(b){try{let d=await c.stripe.checkout.sessions.retrieve(b);if("paid"!==d.payment_status)return{success:!1,message:"Payment not completed"};let e=d.metadata||{},g=e.userId,h=e.loanId,i=e.emiId,j=e.amount;if(!g||!h||!i||!j)throw Error("Missing required metadata");await (0,f.default)();let{Loan:k,EmiPayment:l,Transaction:m,Account:n}=await a.A(2050),o=await l.findByIdAndUpdate(i,{status:"paid",paidDate:new Date,paidAmount:parseFloat(j)},{new:!0});if(!o)throw Error("EMI not found");let p=await k.findById(h);if(!p)throw Error("Loan not found");p.amountPaid=(p.amountPaid||0)+parseFloat(j);let q=p.amountPaid,r=p.amount+(p.interestAmount||0);return q>=r&&(p.status="closed"),await p.save(),await m.create({userId:g,accountId:p.disbursementAccountId,type:"emi_payment",amount:-parseFloat(j),status:"completed",description:`EMI #${o.emiNumber} payment for ${p.loanType} loan`,reference:b}),await n.findByIdAndUpdate(p.disbursementAccountId,{$inc:{balance:-parseFloat(j)}}),{success:!0,message:"EMI payment successful",emiNumber:o.emiNumber,amount:parseFloat(j)}}catch(a){return console.error("‚ùå Error processing EMI payment:",a),{success:!1,message:a instanceof Error?a.message:"Payment processing failed"}}}(0,g.ensureServerEntryExports)([i,j,k,l,m]),(0,b.registerServerReference)(i,"607e976aed26103946f2417047419cafb2c31a523d",null),(0,b.registerServerReference)(j,"60429288925cf7be0fd4025e1bb62d662780b654c3",null),(0,b.registerServerReference)(k,"4007a2597564fe9d55e48129aaa632373d13e33058",null),(0,b.registerServerReference)(l,"60dcc0a6fcbb3b27a67cf6becb2c0a6cbace7f9735",null),(0,b.registerServerReference)(m,"40d74d057b6e66fced094c113a69cbbb525c1e13e5",null),a.s(["getCheckoutSessionStatus",()=>k,"handleEMIPaymentSuccess",()=>m,"startCustomDepositCheckout",()=>j,"startDepositCheckout",()=>i,"startEMIPaymentCheckout",()=>l])},83176,a=>{"use strict";var b=a.i(40007),c=a.i(1956);a.i(33942);var d=a.i(34e3),e=a.i(20779),f=a.i(92964);let g=(0,a.i(68476).default)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);var h=a.i(43917),i=a.i(29171),j=a.i(72651),k=a.i(99044),l=a.i(22017),m=a.i(13761),n=a.i(26046);let o=async function(b){console.log("üîÑ Manual balance update starting for session:",b);try{let{stripe:c}=await a.A(10663),d=await c.checkout.sessions.retrieve(b);if(console.log("üìã Session retrieved:",{id:d.id,payment_status:d.payment_status,metadata:d.metadata,amount_total:d.amount_total}),"paid"!==d.payment_status)return console.log("‚ö†Ô∏è Payment not completed, skipping balance update"),{success:!1,error:"Payment not completed"};let e=d.metadata?.accountId,f=d.metadata?.userId,g=d.amount_total?d.amount_total/100:0;if(console.log("üí∞ Payment details:",{accountId:e,userId:f,amount:g}),!e)return console.error("‚ùå No accountId in metadata"),{success:!1,error:"Missing account ID"};if(!n.default.Types.ObjectId.isValid(e))return console.error("‚ùå Invalid accountId format:",e),{success:!1,error:"Invalid account ID"};if(g<=0)return console.error("‚ùå Invalid amount:",g),{success:!1,error:"Invalid amount"};if(await (0,l.default)(),console.log("‚úÖ Database connected"),await m.Transaction.findOne({referenceId:b}))return console.log("‚ö†Ô∏è Transaction already processed, skipping"),{success:!0,alreadyProcessed:!0,message:"Deposit already processed"};console.log("üîç Finding account:",e);let h=await m.Account.findById(e);if(!h)return console.error("‚ùå Account not found"),{success:!1,error:"Account not found"};console.log("üì¶ Account found:",{id:h._id.toString(),currentBalance:h.balance,userId:h.userId}),console.log("üíµ Updating balance by:",g);let i=await m.Account.findByIdAndUpdate(e,{$inc:{balance:g}},{new:!0});if(!i)return console.error("‚ùå Account update failed"),{success:!1,error:"Failed to update balance"};console.log("‚úÖ Balance updated:",{previousBalance:h.balance,amountAdded:g,newBalance:i.balance});let j=await m.Transaction.create({userId:f||i.userId,accountId:i._id,amount:g,type:"deposit",status:"completed",referenceId:b,description:`Stripe deposit - ${new Date().toLocaleDateString()}`});console.log("‚úÖ Transaction record created:",j._id.toString());let k=await m.Account.findById(e);return console.log("üîç Verification:",{updatedBalance:i.balance,verifiedBalance:k?.balance,match:i.balance===k?.balance}),{success:!0,newBalance:i.balance,transactionId:j._id.toString()}}catch(a){return console.error("‚ùå Balance update error:",a),console.error("Error details:",{name:a instanceof Error?a.name:"Unknown",message:a instanceof Error?a.message:"Unknown",stack:a instanceof Error?a.stack:void 0}),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}};async function p({searchParams:a}){let c=(await a).session_id;c||(0,d.redirect)("/dashboard/deposit");let l=await (0,k.getCheckoutSessionStatus)(c);if(!l)return(0,b.jsx)("div",{className:"flex items-center justify-center min-h-[60vh]",children:(0,b.jsx)(i.Card,{className:"max-w-md w-full",children:(0,b.jsxs)(i.CardContent,{className:"pt-6 text-center space-y-4",children:[(0,b.jsx)(f.XCircle,{className:"h-16 w-16 text-red-500 mx-auto"}),(0,b.jsx)("h1",{className:"text-2xl font-bold",children:"Error"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"Unable to verify payment status. Please contact support if you were charged."}),(0,b.jsxs)("div",{className:"flex gap-2 justify-center",children:[(0,b.jsx)(h.Button,{asChild:!0,variant:"outline",children:(0,b.jsx)(j.default,{href:"/dashboard/deposit",children:"Try Again"})}),(0,b.jsx)(h.Button,{asChild:!0,children:(0,b.jsx)(j.default,{href:"/dashboard",children:"Go to Dashboard"})})]})]})})});let m=null;"paid"===l.payment_status&&console.log("Balance update result:",m=await o(c));let n="paid"===l.payment_status,p="unpaid"===l.payment_status||"open"===l.status;return(0,b.jsx)("div",{className:"flex items-center justify-center min-h-[60vh] p-4",children:(0,b.jsx)(i.Card,{className:"max-w-md w-full",children:(0,b.jsx)(i.CardContent,{className:"pt-6 text-center space-y-4",children:n?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-green-100 mx-auto",children:(0,b.jsx)(e.CheckCircle2,{className:"h-10 w-10 text-green-600"})}),(0,b.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Deposit Successful!"}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)("p",{className:"text-muted-foreground",children:"Your account balance has been updated."}),l.amount_total&&(0,b.jsxs)("p",{className:"text-lg font-semibold text-foreground",children:["Amount: $",(l.amount_total/100).toFixed(2)]}),m?.alreadyProcessed&&(0,b.jsx)("p",{className:"text-sm text-amber-600",children:"(Already processed by webhook)"}),l.customer_email&&(0,b.jsxs)("p",{className:"text-sm text-muted-foreground",children:["A confirmation email has been sent to"," ",(0,b.jsx)("span",{className:"font-medium",children:l.customer_email})]})]}),(0,b.jsxs)("div",{className:"pt-4 space-y-2",children:[(0,b.jsx)(h.Button,{asChild:!0,className:"w-full",children:(0,b.jsx)(j.default,{href:"/dashboard",children:"View Dashboard"})}),(0,b.jsx)(h.Button,{asChild:!0,variant:"outline",className:"w-full",children:(0,b.jsx)(j.default,{href:"/dashboard/deposit",children:"Make Another Deposit"})})]})]}):p?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-orange-100 mx-auto",children:(0,b.jsx)(g,{className:"h-10 w-10 text-orange-600 animate-spin"})}),(0,b.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Payment Processing"}),(0,b.jsxs)("p",{className:"text-muted-foreground",children:["Your payment is being processed. This usually takes a few moments.",(0,b.jsx)("br",{}),(0,b.jsxs)("span",{className:"text-sm",children:["Status: ",l.status]})]}),(0,b.jsxs)("div",{className:"pt-4 space-y-2",children:[(0,b.jsx)(h.Button,{asChild:!0,className:"w-full",children:(0,b.jsx)(j.default,{href:"/dashboard",children:"Go to Dashboard"})}),(0,b.jsx)(h.Button,{asChild:!0,variant:"outline",className:"w-full",onClick:()=>window.location.reload(),children:(0,b.jsx)("a",{href:"#",children:"Refresh Status"})})]})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-red-100 mx-auto",children:(0,b.jsx)(f.XCircle,{className:"h-10 w-10 text-red-600"})}),(0,b.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Payment Failed"}),(0,b.jsxs)("p",{className:"text-muted-foreground",children:["Your payment could not be processed. Please try again.",(0,b.jsx)("br",{}),(0,b.jsxs)("span",{className:"text-sm",children:["Status: ",l.payment_status]})]}),(0,b.jsxs)("div",{className:"pt-4 space-y-2",children:[(0,b.jsx)(h.Button,{asChild:!0,className:"w-full",children:(0,b.jsx)(j.default,{href:"/dashboard/deposit",children:"Try Again"})}),(0,b.jsx)(h.Button,{asChild:!0,variant:"outline",className:"w-full",children:(0,b.jsx)(j.default,{href:"/dashboard",children:"Go to Dashboard"})})]})]})})})})}(0,c.registerServerReference)(o,"40560b3a5764cfa41168786618fc68279ddb97d373",null),a.s(["$$RSC_SERVER_ACTION_0",0,o,"default",()=>p],83176)}];

//# sourceMappingURL=app_0a9207e6._.js.map