{"version":3,"sources":["../../../../app/%28dashboard%29/dashboard/deposit/confirm/page.tsx"],"sourcesContent":["// app/api/deposit/confirm/route.ts\r\n// TEMPORARY: Manual balance update after payment\r\n// Remove this once webhook is working\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { auth } from \"@clerk/nextjs/server\";\r\nimport { stripe } from \"@/lib/stripe\";\r\nimport dbConnect from \"@/lib/mongodb\";\r\nimport { Account } from \"@/lib/models\";\r\nimport mongoose from \"mongoose\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const session = await auth();\r\n    if (!session.userId) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const { sessionId } = await req.json();\r\n\r\n    if (!sessionId) {\r\n      return NextResponse.json(\r\n        { error: \"Session ID required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    console.log(\"üîç Confirming payment for session:\", sessionId);\r\n\r\n    // Retrieve the checkout session from Stripe\r\n    const checkoutSession = await stripe.checkout.sessions.retrieve(sessionId);\r\n\r\n    console.log(\"üìä Session details:\", {\r\n      id: checkoutSession.id,\r\n      payment_status: checkoutSession.payment_status,\r\n      metadata: checkoutSession.metadata,\r\n    });\r\n\r\n    // Only process if payment was successful\r\n    if (checkoutSession.payment_status !== \"paid\") {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"Payment not completed\",\r\n          status: checkoutSession.payment_status,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const accountId = checkoutSession.metadata?.accountId;\r\n    const amount = checkoutSession.amount_total\r\n      ? checkoutSession.amount_total / 100\r\n      : 0;\r\n\r\n    if (!accountId) {\r\n      return NextResponse.json(\r\n        { error: \"Missing account ID in session metadata\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verify user owns the account\r\n    await dbConnect();\r\n\r\n    if (!mongoose.Types.ObjectId.isValid(accountId)) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid account ID\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const updatedAccount = await Account.findOneAndUpdate(\r\n      {\r\n        _id: accountId,\r\n        userId: session.userId,\r\n      },\r\n      { $inc: { balance: amount } },\r\n      { new: true, runValidators: true }\r\n    );\r\n\r\n    if (!updatedAccount) {\r\n      return NextResponse.json(\r\n        { error: \"Account not found or unauthorized\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    console.log(\"‚úÖ Balance updated successfully:\", {\r\n      accountId: updatedAccount._id.toString(),\r\n      newBalance: updatedAccount.balance,\r\n      addedAmount: amount,\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      newBalance: updatedAccount.balance,\r\n      depositAmount: amount,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"‚ùå Error confirming deposit:\", error);\r\n    return NextResponse.json(\r\n      { error: \"Failed to confirm deposit\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"6pBAIA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEO,eAAe,EAAK,CAAgB,EACzC,GAAI,CACF,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,IAAA,AAAI,IAC1B,GAAI,CAAC,EAAQ,MAAM,CACjB,CADmB,MACZ,EAAA,YAAY,CAAC,IAAI,CAAC,CAAE,MAAO,cAAe,EAAG,CAAE,OAAQ,GAAI,GAGpE,GAAM,WAAE,CAAS,CAAE,CAAG,MAAM,EAAI,IAAI,GAEpC,GAAI,CAAC,EACH,OAAO,EAAA,AADO,YACK,CAAC,IAAI,CACtB,CAAE,MAAO,qBAAsB,EAC/B,CAAE,OAAQ,GAAI,GAIlB,QAAQ,GAAG,CAAC,qCAAsC,GAGlD,IAAM,EAAkB,MAAM,EAAA,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC,GAShE,GAPA,QAAQ,GAAG,CAAC,sBAAuB,CACjC,GAAI,EAAgB,EAAE,CACtB,eAAgB,EAAgB,cAAc,CAC9C,SAAU,EAAgB,QAAQ,AACpC,GAGuC,QAAQ,CAA3C,EAAgB,cAAc,CAChC,OAAO,EAAA,YAAY,CAAC,IAAI,CACtB,CACE,MAAO,wBACP,OAAQ,EAAgB,cAC1B,AADwC,EAExC,CAAE,OAAQ,GAAI,GAIlB,IAAM,EAAY,EAAgB,QAAQ,EAAE,UACtC,EAAS,EAAgB,YAAY,CACvC,EAAgB,YAAY,CAAG,IAC/B,EAEJ,GAAI,CAAC,EACH,OAAO,EADO,AACP,YAAY,CAAC,IAAI,CACtB,CAAE,MAAO,wCAAyC,EAClD,CAAE,OAAQ,GAAI,GAOlB,GAFA,MAAM,CAAA,EAAA,EAAA,OAAA,AAAS,IAEX,CAAC,EAAA,OAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,GACnC,OAAO,EADwC,AACxC,YAAY,CAAC,IAAI,CACtB,CAAE,MAAO,oBAAqB,EAC9B,CAAE,OAAQ,GAAI,GAIlB,IAAM,EAAiB,MAAM,EAAA,OAAO,CAAC,gBAAgB,CACnD,CACE,IAAK,EACL,OAAQ,EAAQ,MAAM,AACxB,EACA,CAAE,KAAM,CAAE,QAAS,CAAO,CAAE,EAC5B,CAAE,KAAK,EAAM,eAAe,CAAK,GAGnC,GAAI,CAAC,EACH,OAAO,EAAA,KADY,OACA,CAAC,IAAI,CACtB,CAAE,MAAO,mCAAoC,EAC7C,CAAE,OAAQ,GAAI,GAUlB,OANA,QAAQ,GAAG,CAAC,kCAAmC,CAC7C,UAAW,EAAe,GAAG,CAAC,QAAQ,GACtC,WAAY,EAAe,OAAO,CAClC,YAAa,CACf,GAEO,EAAA,YAAY,CAAC,IAAI,CAAC,CACvB,SAAS,EACT,WAAY,EAAe,OAAO,CAClC,cAAe,CACjB,EACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,8BAA+B,GACtC,EAAA,YAAY,CAAC,IAAI,CACtB,CAAE,MAAO,2BAA4B,EACrC,CAAE,OAAQ,GAAI,EAElB,CACF"}