{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/lavan/Downloads/banking-web-application/lib/mongodb.ts"],"sourcesContent":["// lib/mongodb.ts\r\nimport mongoose from \"mongoose\";\r\n\r\nconst MONGO_URI = process.env.DATABASE_URL!;\r\nif (!MONGO_URI) throw new Error(\"Please define DATABASE_URL in your .env\");\r\n\r\n// Cache the connection across hot reloads (Next.js)\r\nlet cached = (global as any).mongoose;\r\n\r\nif (!cached) {\r\n  cached = (global as any).mongoose = { conn: null, promise: null };\r\n}\r\n\r\nasync function dbConnect() {\r\n  if (cached.conn) return cached.conn;\r\n\r\n  if (!cached.promise) {\r\n    cached.promise = mongoose.connect(MONGO_URI).then((mongoose) => mongoose);\r\n  }\r\n  cached.conn = await cached.promise;\r\n  return cached.conn;\r\n}\r\n\r\nexport default dbConnect;\r\n"],"names":[],"mappings":"AAAA,iBAAiB;;;;;AACjB;;AAEA,MAAM,YAAY,QAAQ,GAAG,CAAC,YAAY;AAC1C,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;AAEhC,oDAAoD;AACpD,IAAI,SAAS,yDAAgB,QAAQ;AAErC,IAAI,CAAC,QAAQ;IACX,SAAS,yDAAgB,QAAQ,GAAG;QAAE,MAAM;QAAM,SAAS;IAAK;AAClE;AAEA,eAAe;IACb,IAAI,OAAO,IAAI,EAAE,OAAO,OAAO,IAAI;IAEnC,IAAI,CAAC,OAAO,OAAO,EAAE;QACnB,OAAO,OAAO,GAAG,oHAAQ,CAAC,OAAO,CAAC,WAAW,IAAI,CAAC,CAAC,WAAa;IAClE;IACA,OAAO,IAAI,GAAG,MAAM,OAAO,OAAO;IAClC,OAAO,OAAO,IAAI;AACpB;uCAEe"}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/lavan/Downloads/banking-web-application/lib/models.ts"],"sourcesContent":["// lib/models.ts\r\nimport mongoose, { Schema, Document } from \"mongoose\";\r\n\r\nconst { ObjectId } = Schema.Types;\r\n\r\n// =======================\r\n// 1Ô∏è‚É£ Profile\r\n// =======================\r\nexport interface IProfile extends Document {\r\n  clerkId: string; // Changed: Add clerkId as the primary identifier\r\n  email: string;\r\n  fullName?: string;\r\n  phone?: string;\r\n  address?: string;\r\n  kycStatus: string;\r\n  isAdmin: boolean;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst ProfileSchema = new Schema<IProfile>(\r\n  {\r\n    clerkId: { type: String, unique: true, required: true }, // Changed: Use Clerk ID\r\n    email: { type: String, unique: true, required: true },\r\n    fullName: String,\r\n    phone: String,\r\n    address: String,\r\n    kycStatus: { type: String, default: \"pending\" },\r\n    isAdmin: { type: Boolean, default: false },\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\n// =======================\r\n// 2Ô∏è‚É£ Account\r\n// =======================\r\nexport interface IAccount extends Document {\r\n  userId: string; // Changed: String instead of ObjectId\r\n  accountNumber: string;\r\n  accountType: string;\r\n  balance: number;\r\n  currency: string;\r\n  status: string;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst AccountSchema = new Schema<IAccount>(\r\n  {\r\n    userId: { type: String, required: true }, // Changed: String for Clerk ID\r\n    accountNumber: { type: String, unique: true, required: true },\r\n    accountType: String,\r\n    balance: { type: Number, default: 0 },\r\n    currency: { type: String, default: \"USD\" },\r\n    status: { type: String, default: \"active\" },\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\n// =======================\r\n// 3Ô∏è‚É£ Transaction\r\n// =======================\r\nexport interface ITransaction extends Document {\r\n  userId: string; // Changed: String instead of ObjectId\r\n  accountId: mongoose.Types.ObjectId;\r\n  amount: number;\r\n  type: string;\r\n  status: string;\r\n  description?: string;\r\n  referenceId?: string;\r\n  recipientAccountId?: mongoose.Types.ObjectId;\r\n  recipientUserId?: string; // Changed: String instead of ObjectId\r\n  createdAt: Date;\r\n}\r\n\r\nconst TransactionSchema = new Schema<ITransaction>(\r\n  {\r\n    userId: { type: String, required: true }, // Changed: String for Clerk ID\r\n    accountId: { type: ObjectId, ref: \"Account\", required: true },\r\n    amount: { type: Number, required: true },\r\n    type: { type: String, required: true },\r\n    status: { type: String, default: \"completed\" },\r\n    description: String,\r\n    referenceId: String,\r\n    recipientAccountId: { type: ObjectId, ref: \"Account\" },\r\n    recipientUserId: { type: String }, // Changed: String for Clerk ID\r\n  },\r\n  { timestamps: { createdAt: true, updatedAt: false } }\r\n);\r\n\r\n// =======================\r\n// 4Ô∏è‚É£ Loan\r\n// =======================\r\nexport interface ILoan extends Document {\r\n  userId: string; // Changed: String instead of ObjectId\r\n  loanType: string;\r\n  amount: number;\r\n  interestRate: number;\r\n  tenureMonths: number;\r\n  emiAmount: number;\r\n  totalPayable: number;\r\n  amountPaid: number;\r\n  remainingAmount?: number;\r\n  status: string;\r\n  disbursementAccountId?: mongoose.Types.ObjectId;\r\n  approvedBy?: string; // Changed: String instead of ObjectId\r\n  approvedAt?: Date;\r\n  disbursedAt?: Date;\r\n  nextEmiDate?: Date;\r\n  createdAt: Date;\r\n  updatedAt: Date;\r\n}\r\n\r\nconst LoanSchema = new Schema<ILoan>(\r\n  {\r\n    userId: { type: String, required: true }, // Changed: String for Clerk ID\r\n    loanType: String,\r\n    amount: Number,\r\n    interestRate: Number,\r\n    tenureMonths: Number,\r\n    emiAmount: Number,\r\n    totalPayable: Number,\r\n    amountPaid: { type: Number, default: 0 },\r\n    remainingAmount: Number,\r\n    status: { type: String, default: \"pending\" },\r\n    disbursementAccountId: { type: ObjectId, ref: \"Account\" },\r\n    approvedBy: { type: String }, // Changed: String for Clerk ID\r\n    approvedAt: Date,\r\n    disbursedAt: Date,\r\n    nextEmiDate: Date,\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\n// =======================\r\n// 5Ô∏è‚É£ EmiPayment\r\n// =======================\r\nexport interface IEmiPayment extends Document {\r\n  loanId: mongoose.Types.ObjectId;\r\n  userId: string; // Changed: String instead of ObjectId\r\n  emiNumber: number;\r\n  amount: number;\r\n  principalAmount: number;\r\n  interestAmount: number;\r\n  dueDate: Date;\r\n  paidDate?: Date;\r\n  status: string;\r\n  stripePaymentId?: string;\r\n  transactionId?: mongoose.Types.ObjectId;\r\n  createdAt: Date;\r\n}\r\n\r\nconst EmiPaymentSchema = new Schema<IEmiPayment>(\r\n  {\r\n    loanId: { type: ObjectId, ref: \"Loan\", required: true },\r\n    userId: { type: String, required: true, index: true }, // Changed: String for Clerk ID\r\n    emiNumber: Number,\r\n    amount: Number,\r\n    principalAmount: Number,\r\n    interestAmount: Number,\r\n    dueDate: Date,\r\n    paidDate: Date,\r\n    status: { type: String, default: \"pending\" },\r\n    stripePaymentId: String,\r\n    transactionId: { type: ObjectId, ref: \"Transaction\" },\r\n  },\r\n  { timestamps: { createdAt: true, updatedAt: false } }\r\n);\r\n\r\n// =======================\r\n// 6Ô∏è‚É£ BankSetting\r\n// =======================\r\nexport interface IBankSetting extends Document {\r\n  settingKey: string;\r\n  settingValue: string;\r\n  description?: string;\r\n  updatedBy?: string; // Changed: String instead of ObjectId\r\n  updatedAt: Date;\r\n}\r\n\r\nconst BankSettingSchema = new Schema<IBankSetting>(\r\n  {\r\n    settingKey: { type: String, unique: true },\r\n    settingValue: String,\r\n    description: String,\r\n    updatedBy: { type: String }, // Changed: String for Clerk ID\r\n  },\r\n  { timestamps: { createdAt: false, updatedAt: true } }\r\n);\r\n\r\n// =======================\r\n// Export all models\r\n// =======================\r\nexport const Profile =\r\n  mongoose.models.Profile || mongoose.model(\"Profile\", ProfileSchema);\r\nexport const Account =\r\n  mongoose.models.Account || mongoose.model(\"Account\", AccountSchema);\r\nexport const Transaction =\r\n  mongoose.models.Transaction ||\r\n  mongoose.model(\"Transaction\", TransactionSchema);\r\nexport const Loan = mongoose.models.Loan || mongoose.model(\"Loan\", LoanSchema);\r\nexport const EmiPayment =\r\n  mongoose.models.EmiPayment || mongoose.model(\"EmiPayment\", EmiPaymentSchema);\r\nexport const BankSetting =\r\n  mongoose.models.BankSetting ||\r\n  mongoose.model(\"BankSetting\", BankSettingSchema);\r\n\r\n// lib/models.ts (add this to your existing models file)\r\n\r\nconst bankSettingsSchema = new mongoose.Schema(\r\n  {\r\n    userId: {\r\n      type: String,\r\n      required: true,\r\n      unique: true,\r\n      index: true,\r\n    },\r\n    bankName: {\r\n      type: String,\r\n      default: \"Your Bank\",\r\n    },\r\n    transactionLimits: {\r\n      daily: {\r\n        type: Number,\r\n        default: 10000,\r\n      },\r\n      perTransaction: {\r\n        type: Number,\r\n        default: 5000,\r\n      },\r\n    },\r\n    interestRates: {\r\n      savings: {\r\n        type: Number,\r\n        default: 3.5,\r\n      },\r\n      checking: {\r\n        type: Number,\r\n        default: 0.5,\r\n      },\r\n    },\r\n    fees: {\r\n      monthlyMaintenance: {\r\n        type: Number,\r\n        default: 0,\r\n      },\r\n      overdraft: {\r\n        type: Number,\r\n        default: 35,\r\n      },\r\n      atmWithdrawal: {\r\n        type: Number,\r\n        default: 2.5,\r\n      },\r\n    },\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nexport const BankSettings =\r\n  mongoose.models.BankSettings ||\r\n  mongoose.model(\"BankSettings\", bankSettingsSchema);\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 349, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/lavan/Downloads/banking-web-application/app/api/recover-my-account/route.ts"],"sourcesContent":["// app/api/recover-my-account/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport { currentUser } from \"@clerk/nextjs/server\";\r\nimport dbConnect from \"@/lib/mongodb\";\r\nimport { Account, Transaction, Loan, EmiPayment } from \"@/lib/models\";\r\n\r\nexport async function POST() {\r\n  try {\r\n    await dbConnect();\r\n    const user = await currentUser();\r\n\r\n    if (!user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n    }\r\n\r\n    const userId = user.id;\r\n\r\n    console.log(\"========================================\");\r\n    console.log(\"üîß STARTING RECOVERY FOR USER:\", userId);\r\n    console.log(\"========================================\");\r\n\r\n    let accountsCreated = 0;\r\n    let accountsFixed = 0;\r\n    let transactionsLinked = 0;\r\n    let loansLinked = 0;\r\n    let emisLinked = 0;\r\n    let totalBalance = 0;\r\n\r\n    // === STEP 1: Get all user data ===\r\n    const existingAccounts = await Account.find({ userId });\r\n    const allTransactions = await Transaction.find({ userId });\r\n    const allLoans = await Loan.find({ userId });\r\n    const allEmis = await EmiPayment.find({ userId });\r\n\r\n    console.log(\"üìä Current state:\");\r\n    console.log(\"  Accounts:\", existingAccounts.length);\r\n    console.log(\"  Transactions:\", allTransactions.length);\r\n    console.log(\"  Loans:\", allLoans.length);\r\n    console.log(\"  EMIs:\", allEmis.length);\r\n\r\n    // === STEP 2: Find accounts that belong to user but have wrong userId ===\r\n    const accountIdsFromTransactions = [\r\n      ...new Set(\r\n        allTransactions\r\n          .filter((t) => t.accountId)\r\n          .map((t) => t.accountId.toString())\r\n      ),\r\n    ];\r\n\r\n    if (accountIdsFromTransactions.length > 0) {\r\n      const wrongOwnershipAccounts = await Account.find({\r\n        _id: { $in: accountIdsFromTransactions },\r\n        userId: { $ne: userId },\r\n      });\r\n\r\n      if (wrongOwnershipAccounts.length > 0) {\r\n        console.log(\r\n          `üîß Found ${wrongOwnershipAccounts.length} accounts with wrong userId...`\r\n        );\r\n        const fixResult = await Account.updateMany(\r\n          {\r\n            _id: { $in: accountIdsFromTransactions },\r\n            userId: { $ne: userId },\r\n          },\r\n          { userId }\r\n        );\r\n        accountsFixed = fixResult.modifiedCount;\r\n        console.log(`‚úÖ Fixed ${accountsFixed} account ownerships`);\r\n      }\r\n    }\r\n\r\n    // Refresh accounts after fixing ownership\r\n    const updatedAccounts = await Account.find({ userId });\r\n\r\n    // === STEP 3: Create missing accounts based on transactions ===\r\n    const hasTransactions = allTransactions.length > 0;\r\n    let primaryAccount = updatedAccounts.find(\r\n      (acc) => acc.accountType === \"savings\"\r\n    );\r\n\r\n    if (hasTransactions && !primaryAccount) {\r\n      console.log(\"üìù Creating primary savings account...\");\r\n      primaryAccount = await Account.create({\r\n        userId,\r\n        accountNumber: `SAV${Date.now()}`,\r\n        accountType: \"savings\",\r\n        balance: 0, // Will calculate later\r\n        currency: \"USD\",\r\n        status: \"active\",\r\n      });\r\n      accountsCreated++;\r\n      console.log(\r\n        `‚úÖ Created savings account: ${primaryAccount.accountNumber}`\r\n      );\r\n    }\r\n\r\n    // === STEP 4: Link orphaned transactions to accounts ===\r\n    const orphanedTransactions = await Transaction.find({\r\n      userId,\r\n      $or: [{ accountId: null }, { accountId: { $exists: false } }],\r\n    });\r\n\r\n    if (orphanedTransactions.length > 0 && primaryAccount) {\r\n      console.log(\r\n        `üîó Linking ${orphanedTransactions.length} orphaned transactions...`\r\n      );\r\n      const txResult = await Transaction.updateMany(\r\n        {\r\n          userId,\r\n          $or: [{ accountId: null }, { accountId: { $exists: false } }],\r\n        },\r\n        { accountId: primaryAccount._id }\r\n      );\r\n      transactionsLinked = txResult.modifiedCount;\r\n      console.log(`‚úÖ Linked ${transactionsLinked} transactions`);\r\n    }\r\n\r\n    // === STEP 5: Fix loans WITHOUT disbursement accounts ===\r\n    const loansNeedingAccounts = await Loan.find({\r\n      userId,\r\n      $or: [\r\n        { disbursementAccountId: null },\r\n        { disbursementAccountId: { $exists: false } },\r\n      ],\r\n    });\r\n\r\n    if (loansNeedingAccounts.length > 0 && primaryAccount) {\r\n      console.log(\r\n        `üîó Linking ${loansNeedingAccounts.length} loans to account...`\r\n      );\r\n\r\n      for (const loan of loansNeedingAccounts) {\r\n        await Loan.updateOne(\r\n          { _id: loan._id },\r\n          { disbursementAccountId: primaryAccount._id }\r\n        );\r\n        loansLinked++;\r\n      }\r\n\r\n      console.log(`‚úÖ Linked ${loansLinked} loans to account`);\r\n    }\r\n\r\n    // === STEP 6: Check EMI-Transaction links (but don't count as orphaned) ===\r\n    const emisNeedingTransactionLink = await EmiPayment.find({\r\n      userId,\r\n      status: \"paid\",\r\n      $or: [{ transactionId: null }, { transactionId: { $exists: false } }],\r\n    });\r\n\r\n    if (emisNeedingTransactionLink.length > 0) {\r\n      console.log(\r\n        `üîó Found ${emisNeedingTransactionLink.length} paid EMIs without transaction links...`\r\n      );\r\n\r\n      for (const emi of emisNeedingTransactionLink) {\r\n        // Try to find matching transaction with more flexible criteria\r\n        const matchingTx = await Transaction.findOne({\r\n          userId,\r\n          type: { $in: [\"emi_payment\", \"debit\", \"EMI Payment\"] },\r\n          amount: { $gte: emi.amount - 1, $lte: emi.amount + 1 }, // Allow ¬±1 variance\r\n          createdAt: {\r\n            $gte: new Date(\r\n              new Date(emi.paidDate || emi.dueDate).getTime() -\r\n                7 * 24 * 60 * 60 * 1000 // 7 days before\r\n            ),\r\n            $lte: new Date(\r\n              new Date(emi.paidDate || emi.dueDate).getTime() +\r\n                1 * 24 * 60 * 60 * 1000 // 1 day after\r\n            ),\r\n          },\r\n        });\r\n\r\n        if (matchingTx) {\r\n          await EmiPayment.updateOne(\r\n            { _id: emi._id },\r\n            { transactionId: matchingTx._id }\r\n          );\r\n          emisLinked++;\r\n        }\r\n      }\r\n\r\n      if (emisLinked > 0) {\r\n        console.log(`‚úÖ Linked ${emisLinked} EMIs to transactions`);\r\n      }\r\n    }\r\n\r\n    // === STEP 7: Calculate accurate balance from ALL transactions ===\r\n    const finalTransactions = await Transaction.find({ userId });\r\n\r\n    finalTransactions.forEach((t) => {\r\n      if ([\"deposit\", \"transfer_in\", \"loan_disbursement\"].includes(t.type)) {\r\n        totalBalance += Number(t.amount);\r\n      } else if (\r\n        [\r\n          \"withdrawal\",\r\n          \"transfer_out\",\r\n          \"emi_payment\",\r\n          \"debit\",\r\n          \"EMI Payment\",\r\n        ].includes(t.type)\r\n      ) {\r\n        totalBalance -= Math.abs(Number(t.amount));\r\n      }\r\n    });\r\n\r\n    console.log(`üí∞ Calculated balance: $${totalBalance.toFixed(2)}`);\r\n\r\n    // === STEP 8: Update account balance ===\r\n    if (primaryAccount) {\r\n      await Account.updateOne(\r\n        { _id: primaryAccount._id },\r\n        { balance: totalBalance }\r\n      );\r\n      console.log(`‚úÖ Updated account balance`);\r\n    }\r\n\r\n    // === STEP 9: Remove any incorrectly created \"loan\" type accounts ===\r\n    const loanTypeAccounts = await Account.find({\r\n      userId,\r\n      accountType: \"loan\",\r\n    });\r\n\r\n    if (loanTypeAccounts.length > 0) {\r\n      console.log(\r\n        `üóëÔ∏è Removing ${loanTypeAccounts.length} incorrect loan accounts...`\r\n      );\r\n      await Account.deleteMany({\r\n        userId,\r\n        accountType: \"loan\",\r\n      });\r\n      console.log(`‚úÖ Cleaned up loan accounts`);\r\n    }\r\n\r\n    console.log(\"========================================\");\r\n    console.log(\"‚úÖ RECOVERY COMPLETE\");\r\n    console.log(\"========================================\");\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: \"All data recovered successfully!\",\r\n      accountsCreated,\r\n      accountsFixed,\r\n      transactionsLinked,\r\n      loansLinked,\r\n      emisLinked,\r\n      totalBalance: Number(totalBalance.toFixed(2)),\r\n      details: {\r\n        totalAccounts: await Account.countDocuments({ userId }),\r\n        totalTransactions: finalTransactions.length,\r\n        totalLoans: allLoans.length,\r\n        totalEmis: allEmis.length,\r\n      },\r\n    });\r\n  } catch (error: any) {\r\n    console.error(\"‚ùå Recovery error:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: error.message || \"Recovery failed\",\r\n        stack: error.stack,\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}