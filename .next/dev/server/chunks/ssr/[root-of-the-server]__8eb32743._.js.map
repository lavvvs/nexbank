{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/lavan/Downloads/banking-web-application/lib/stripe.ts"],"sourcesContent":["import \"server-only\"\nimport Stripe from \"stripe\"\n\nexport const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,MAAM,SAAS,IAAI,iKAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB"}},
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/lavan/Downloads/banking-web-application/app/actions/stripe.ts"],"sourcesContent":["// app/actions/stripe.ts\n\"use server\";\n\nimport { stripe } from \"@/lib/stripe\";\nimport { auth } from \"@clerk/nextjs/server\";\nimport { Account } from \"@/lib/models\";\nimport dbConnect from \"@/lib/mongodb\";\n\nconst DEPOSIT_OPTIONS = [\n  { id: \"deposit-100\", name: \"Deposit $100\", amount: 10000 },\n  { id: \"deposit-500\", name: \"Deposit $500\", amount: 50000 },\n  { id: \"deposit-1000\", name: \"Deposit $1,000\", amount: 100000 },\n  { id: \"deposit-5000\", name: \"Deposit $5,000\", amount: 500000 },\n];\n\nexport async function startDepositCheckout(\n  depositId: string,\n  accountId: string\n) {\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  const deposit = DEPOSIT_OPTIONS.find((d) => d.id === depositId);\n  if (!deposit) throw new Error(`Deposit option \"${depositId}\" not found`);\n\n  await dbConnect();\n  const account = await Account.findOne({ _id: accountId, userId }).lean();\n  if (!account) throw new Error(\"Account not found\");\n\n  console.log(\"Creating checkout session:\", {\n    depositId,\n    accountId,\n    amount: deposit.amount / 100,\n    userId,\n  });\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    // FIX 1: Add return_url instead of redirect_on_completion\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: deposit.name,\n            description: `Add funds to your ${account.accountType} account (${account.accountNumber})`,\n          },\n          unit_amount: deposit.amount,\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId,\n      accountId,\n      depositId,\n      amount: (deposit.amount / 100).toString(),\n      type: \"deposit\",\n    },\n  });\n\n  console.log(\"✅ Checkout session created:\", sessionObj.id);\n  return sessionObj.client_secret;\n}\n\nexport async function startCustomDepositCheckout(\n  amount: number,\n  accountId: string\n) {\n  if (amount < 10 || amount > 100000)\n    throw new Error(\"Amount must be between $10 and $100,000\");\n\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  await dbConnect();\n  const account = await Account.findOne({ _id: accountId, userId }).lean();\n  if (!account) throw new Error(\"Account not found\");\n\n  console.log(\"Creating custom checkout session:\", {\n    amount,\n    accountId,\n    userId,\n  });\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    // FIX 1: Add return_url instead of redirect_on_completion\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/deposit/return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: `Deposit $${amount.toFixed(2)}`,\n            description: `Add funds to your ${account.accountType} account (${account.accountNumber})`,\n          },\n          unit_amount: Math.round(amount * 100),\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId,\n      accountId,\n      depositId: \"custom\",\n      amount: amount.toString(),\n      type: \"deposit\",\n    },\n  });\n\n  console.log(\"✅ Custom checkout session created:\", sessionObj.id);\n  return sessionObj.client_secret;\n}\n\n// Helper function to retrieve session status\nexport async function getCheckoutSessionStatus(sessionId: string) {\n  try {\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n    console.log(\"Session status:\", {\n      id: session.id,\n      status: session.status,\n      payment_status: session.payment_status,\n    });\n\n    return {\n      status: session.status,\n      payment_status: session.payment_status,\n      customer_email: session.customer_details?.email,\n      amount_total: session.amount_total,\n    };\n  } catch (error) {\n    console.error(\"❌ Error retrieving session:\", error);\n    return null;\n  }\n}\n// Add this import at the top if not already there\nimport type Stripe from \"stripe\";\n\n// EMI Payment Checkout\nexport async function startEMIPaymentCheckout(emiId: string, loanId: string) {\n  const session = await auth();\n  const userId = session.userId;\n  if (!userId) throw new Error(\"You must be logged in\");\n\n  await dbConnect();\n\n  const { Loan, EmiPayment } = await import(\"@/lib/models\");\n\n  const loan = await Loan.findOne({ _id: loanId, userId }).lean();\n  if (!loan) throw new Error(\"Loan not found\");\n\n  const emi = await EmiPayment.findOne({ _id: emiId, loanId }).lean();\n  if (!emi) throw new Error(\"EMI not found\");\n\n  if (emi.status === \"paid\") {\n    throw new Error(\"This EMI has already been paid\");\n  }\n\n  const sessionObj = await stripe.checkout.sessions.create({\n    ui_mode: \"embedded\",\n    return_url: `${process.env.NEXT_PUBLIC_BASE_URL}/dashboard/loans/emi-return?session_id={CHECKOUT_SESSION_ID}`,\n    line_items: [\n      {\n        price_data: {\n          currency: \"usd\",\n          product_data: {\n            name: `EMI Payment #${emi.emiNumber}`,\n            description: `${loan.loanType} Loan - Due ${new Date(\n              emi.dueDate\n            ).toLocaleDateString()}`,\n          },\n          unit_amount: Math.round(emi.amount * 100),\n        },\n        quantity: 1,\n      },\n    ],\n    mode: \"payment\",\n    metadata: {\n      userId: userId,\n      loanId: loanId.toString(),\n      emiId: emiId.toString(),\n      emiNumber: emi.emiNumber.toString(),\n      amount: emi.amount.toString(),\n      type: \"emi_payment\",\n    },\n  });\n\n  return sessionObj.client_secret;\n}\n\n// Handle EMI Payment Success\nexport async function handleEMIPaymentSuccess(sessionId: string) {\n  try {\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\n\n    if (session.payment_status !== \"paid\") {\n      return { success: false, message: \"Payment not completed\" };\n    }\n\n    const metadata = session.metadata || {};\n    const userId = metadata.userId;\n    const loanId = metadata.loanId;\n    const emiId = metadata.emiId;\n    const amount = metadata.amount;\n\n    if (!userId || !loanId || !emiId || !amount) {\n      throw new Error(\"Missing required metadata\");\n    }\n\n    await dbConnect();\n    const { Loan, EmiPayment, Transaction, Account } = await import(\n      \"@/lib/models\"\n    );\n\n    const emi = await EmiPayment.findByIdAndUpdate(\n      emiId,\n      {\n        status: \"paid\",\n        paidDate: new Date(),\n        paidAmount: parseFloat(amount),\n      },\n      { new: true }\n    );\n\n    if (!emi) throw new Error(\"EMI not found\");\n\n    const loan = await Loan.findById(loanId);\n    if (!loan) throw new Error(\"Loan not found\");\n\n    loan.amountPaid = (loan.amountPaid || 0) + parseFloat(amount);\n\n    const totalPaid = loan.amountPaid;\n    const totalAmount = loan.amount + (loan.interestAmount || 0);\n\n    if (totalPaid >= totalAmount) {\n      loan.status = \"closed\";\n    }\n\n    await loan.save();\n\n    const transaction = await Transaction.create({\n      userId,\n      accountId: loan.disbursementAccountId,\n      type: \"emi_payment\",\n      amount: -parseFloat(amount),\n      status: \"completed\",\n      description: `EMI #${emi.emiNumber} payment for ${loan.loanType} loan`,\n      reference: sessionId,\n    });\n\n    await Account.findByIdAndUpdate(loan.disbursementAccountId, {\n      $inc: { balance: -parseFloat(amount) },\n    });\n\n    return {\n      success: true,\n      message: \"EMI payment successful\",\n      emiNumber: emi.emiNumber,\n      amount: parseFloat(amount),\n    };\n  } catch (error) {\n    console.error(\"❌ Error processing EMI payment:\", error);\n    return {\n      success: false,\n      message:\n        error instanceof Error ? error.message : \"Payment processing failed\",\n    };\n  }\n}\n"],"names":[],"mappings":"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"}}]
}